<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quizzes | MindCare</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
       /* General Styling */
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(to bottom, #f5faff, #dbeaff); /* Soft gradient */
    color: #1f4870;
    text-align: center;
    padding: 20px;
}

/* Back to Dashboard Button (Fixed in Top Left Corner) */
a[href="{% url 'dashboard' %}"] {
    position: fixed;
    top: 20px;
    left: 20px;
    background-color: #1f4870 !important;
    color: white !important;
    padding: 10px 16px;
    text-decoration: none;
    border-radius: 5px;
    font-size: 1em;
    font-weight: bold;
    transition: 0.3s;
    z-index: 1000; /* Ensures it stays above other elements */
}

a[href="{% url 'dashboard' %}"]:hover {
    background-color: #163754 !important;
    transform: scale(1.05);
}

/* Quiz Card Styling */
.quiz-card {
    border-radius: 12px;
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    background-color: white;
    padding: 20px;
    cursor: pointer;
}
quiz-options {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .quiz-option {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .feedback-icon {
        font-size: 1.5rem;
        margin-top: 5px;
    }

.quiz-card:hover {
    transform: translateY(-5px);
    box-shadow: 0px 6px 14px rgba(0, 0, 0, 0.2);
}

/* Search Bar */
.search-bar {
    width: 100%;
    max-width: 500px;
    padding: 12px;
    border: 2px solid #1f4870;
    border-radius: 8px;
    font-size: 14px;
}

/* Quiz Modal */
.quiz-modal {
    display: flex;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    justify-content: center;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out, visibility 0.3s;
    overflow-y: auto;
    padding: 20px;
}

.quiz-modal.show {
    opacity: 1;
    visibility: visible;
}

.quiz-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    text-align: justify; /* ‚úÖ Justifies content */
    box-shadow: 0px 6px 14px rgba(0, 0, 0, 0.3);
    max-height: 80vh;
    overflow-y: auto;
}

/* ‚úÖ Style for Questions (Better Readability) */
#quizQuestions {
    text-align: justify;
    line-height: 1.6;
    font-size: 1rem;
}

/* ‚úÖ Style for Quiz Title */
#quizTitle {
    font-size: 1.5rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 15px;
}

/* ‚úÖ Style for Quiz Feedback (Justified) */
#quizResults {
    text-align: justify;
    font-size: 1rem;
    margin-top: 15px;
}


/* Answer Feedback */
.correct {
    color: green;
    font-weight: bold;
}

.incorrect {
    color: red;
    font-weight: bold;
}

/* Progress Bar */
.progress-bar-container {
    width: 100%;
    background-color: #e0e0e0;
    border-radius: 5px;
    margin-top: 10px;
    overflow: hidden;
}

.progress-bar {
    height: 20px;
    width: 0%;
    background: linear-gradient(to right, #1f4870, #163754);
    text-align: center;
    color: white;
    font-size: 14px;
    line-height: 20px;
    transition: width 0.5s ease-in-out;
}

/* Button Styling */
.btn-primary {
    background: #1f4870;
    border: none;
    padding: 10px;
    font-size: 1rem;
    font-weight: bold;
    border-radius: 8px;
    transition: all 0.3s ease-in-out;
    display: block;
    text-align: center;
}

.btn-primary:hover {
    background: #163754;
    transform: scale(1.05);
}

/* Retake Button */
.btn-warning {
    background: #1f4870;
    border: none;
    padding: 10px;
    font-size: 1rem;
    font-weight: bold;
    border-radius: 8px;
    transition: all 0.3s ease-in-out;
    color: white;
}

.btn-warning:hover {
    background: #1f4870;
    transform: scale(1.05);
    color: white;
}

/* Ensure btn-info uses the same color */
.btn-info {
    background: #1f4870 !important;
    border: none !important;
    color: white !important;
    font-weight: bold;
    border-radius: 8px;
    transition: all 0.3s ease-in-out;
}

.btn-info:hover {
    background: #163754 !important;
    transform: scale(1.05);
}

    </style>
</head>
<body>
    <div class="container py-4">
        <h2 class="text-center mb-4">üìù Take a Quiz</h2>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary mb-3">‚¨Ö Back to Dashboard</a>

        <div class="d-flex justify-content-center mb-4">
            <input type="text" class="form-control search-bar" id="quizSearch" placeholder="Search for quizzes..." onkeyup="searchQuizzes()">
        </div>

        <div id="quizContainer" class="row"></div>

        <div class="text-center mt-4">
            <h4>Your Progress üìä</h4>
            <p id="progressReport" class="text-muted">No quizzes taken yet.</p>
            <div class="progress-bar-container">
                <div id="overallProgressBar" class="progress-bar">0%</div>
            </div>
        </div>
    </div>

    <div id="quizModal" class="quiz-modal">
        <div class="quiz-content">
            <h3 id="quizTitle"></h3>
            <div id="quizQuestions"></div>
    
            <div class="progress-bar-container">
                <div id="quizProgressBar" class="progress-bar">0%</div>
            </div>
    
            <button id="submitBtn" class="btn btn-primary mt-3" onclick="submitQuiz()">Submit Answers</button>
            <button id="retakeBtn" class="btn btn-warning mt-3 d-none" onclick="retakeQuiz()">Retake Quiz</button>
            <button class="btn btn-secondary mt-3" onclick="closeQuiz()">Close</button>
            
            <div id="quizResults" class="mt-3"></div>
        </div>
    </div>

    <script>
        let selectedQuiz = null;
let userAnswers = {};
let quizScores = JSON.parse(localStorage.getItem("quizScores")) || {};
const PASSING_SCORE = 70;

document.addEventListener("DOMContentLoaded", function () {
    fetchQuizzes();
    updateProgress();
});

function fetchQuizzes() {
    fetch('/api/quizzes/')
        .then(response => response.json())
        .then(data => {
            displayQuizzes(data.quizzes || []);
            updateProgress();
        })
        .catch(error => console.error("Error fetching quizzes:", error));
}

function displayQuizzes(quizzes) {
    let quizContainer = document.getElementById("quizContainer");
    quizContainer.innerHTML = '';

    quizzes.forEach(quiz => {
        let quizData = quizScores[quiz.id] || { percentage: 0 };
        let hasAttempted = quizData.percentage > 0;
        let passed = quizData.percentage >= PASSING_SCORE;

        let buttonText = hasAttempted
            ? (passed ? "View Score üìä" : "Retake Quiz üîÑ")
            : "Start Quiz üìù";
        let buttonClass = hasAttempted
            ? (passed ? "btn-info" : "btn-warning")
            : "btn-primary";

        let colDiv = document.createElement("div");
        colDiv.classList.add("col-md-4", "mb-4");

        colDiv.innerHTML = `
            <div class="card quiz-card">
                <div class="card-body">
                    <h5 class="card-title">${quiz.title}</h5>
                    <p class="card-text text-muted">${quiz.description}</p>
                    <button class="btn ${buttonClass} w-100" onclick="openQuiz(${quiz.id})">
                        ${buttonText}
                    </button>
                </div>
            </div>
        `;

        quizContainer.appendChild(colDiv);
    });

    updateProgress();
}

function openQuiz(quizId) {
    fetch(`/api/quiz/${quizId}/`)
        .then(response => response.json())
        .then(data => {
            selectedQuiz = data;
            userAnswers = {};
            let quizData = quizScores[quizId] || { percentage: 0 };
            let hasAttempted = quizData.percentage > 0;
            let passed = quizData.percentage >= PASSING_SCORE;

            document.getElementById("quizTitle").innerText = selectedQuiz.title;
            let quizQuestions = document.getElementById("quizQuestions");
            quizQuestions.innerHTML = '';

            selectedQuiz.questions.forEach((question, index) => {
                let userAnswer = hasAttempted ? quizData.userAnswers?.[index] || "" : null;
                let optionsHTML = question.options.map(option => `
                    <div class="quiz-option">
                        <input type="radio" id="q${index}-${option}" name="question${index}" value="${option}" 
                            onchange="saveAnswer(${index}, '${option}')"
                            ${hasAttempted ? "disabled" : ""} ${userAnswer === option ? "checked" : ""} />
                        <label for="q${index}-${option}">${option}</label>
                    </div>
                `).join("");

                let feedbackIcon = hasAttempted
                    ? (userAnswer === question.correct_answer 
                        ? `<span class="text-success">‚úÖ</span>` 
                        : `<span class="text-danger">‚ùå <b>Correct:</b> ${question.correct_answer}</span>`)
                    : '';

                let questionDiv = document.createElement("div");
                questionDiv.classList.add("quiz-question", "mb-3", "p-2");
                questionDiv.innerHTML = `
                    <p class="fw-bold">Q${index + 1}: ${question.text}</p>
                    <div class="quiz-options">${optionsHTML}</div>
                    <div id="result${index}" class="feedback-icon">${feedbackIcon}</div>
                `;

                quizQuestions.appendChild(questionDiv);
            });

            let resultsDiv = document.getElementById("quizResults");
            resultsDiv.innerHTML = "";

            if (hasAttempted) {
                let message = passed
                    ? `<div class="alert alert-success">üéâ Congratulations! You passed this quiz.</div>`
                    : `<div class="alert alert-danger">‚ùå You did not pass. Try again!</div>`;
                resultsDiv.innerHTML = message + quizData.feedback;
            }

            document.getElementById("submitBtn").classList.toggle("d-none", hasAttempted);
            document.getElementById("retakeBtn").classList.toggle("d-none", !hasAttempted);
            document.getElementById("quizModal").classList.add("show");
        })
        .catch(error => alert("Error loading quiz."));
}

function saveAnswer(questionIndex, answer) {
    userAnswers[questionIndex] = answer;
}

function submitQuiz() {
    let score = 0;
    let totalQuestions = selectedQuiz.questions.length;
    let quizResults = document.getElementById("quizResults");
    quizResults.innerHTML = "";

    selectedQuiz.questions.forEach((question, index) => {
        let userAnswer = userAnswers[index] || "No Answer";
        let isCorrect = userAnswer === question.correct_answer;

        // ‚úÖ Show feedback only for wrong answers
        let feedbackDiv = document.getElementById(`result${index}`);
        if (!isCorrect) {
            feedbackDiv.innerHTML = `<span class="text-danger fw-bold">‚ùå Incorrect</span>`;
            quizResults.innerHTML += `
                <p>‚ùå <b>Q${index + 1}:</b> ${question.text} 
                   <br><b>Your Answer:</b> ${userAnswer}
                   <br><b>Correct Answer:</b> ${question.correct_answer}</p>
                <hr>
            `;
        }

        if (isCorrect) score++;
    });

    let percentage = (score / totalQuestions) * 100;
    let feedback = `<h4>Your Score: ${score}/${totalQuestions} (${percentage.toFixed(1)}%)</h4><hr />`;
    let message = percentage >= PASSING_SCORE
        ? `<div class="alert alert-success">üéâ Congratulations! You passed this quiz.</div>`
        : `<div class="alert alert-danger">‚ùå You did not pass. Try again!</div>`;

    quizResults.innerHTML = message + feedback + quizResults.innerHTML;

    quizScores[selectedQuiz.id] = { score, percentage, feedback, userAnswers };
    localStorage.setItem("quizScores", JSON.stringify(quizScores));

    document.getElementById("submitBtn").classList.add("d-none");
    document.getElementById("retakeBtn").classList.remove("d-none");

    fetchQuizzes();
    setTimeout(updateProgress, 500);
}


function retakeQuiz() {
    if (!selectedQuiz) return;

    userAnswers = {};
    delete quizScores[selectedQuiz.id];
    localStorage.setItem("quizScores", JSON.stringify(quizScores));

    document.querySelectorAll("input[type=radio]").forEach(input => {
        input.disabled = false;
        input.checked = false;
    });

    document.querySelectorAll(".feedback-icon").forEach(icon => {
        icon.innerHTML = "";
    });

    document.getElementById("quizResults").innerHTML = "";
    document.getElementById("submitBtn").classList.remove("d-none");
    document.getElementById("retakeBtn").classList.add("d-none");

    document.getElementById("quizModal").classList.add("show");
}

function closeQuiz() {
    document.getElementById("quizModal").classList.remove("show");
}

function updateProgress() {
    let totalQuizzes = document.querySelectorAll(".quiz-card").length;
    let completedQuizzes = Object.values(quizScores).filter(q => q.percentage >= PASSING_SCORE).length;

    let progressPercentage = totalQuizzes > 0 ? (completedQuizzes / totalQuizzes) * 100 : 0;

    document.getElementById("overallProgressBar").style.width = `${progressPercentage}%`;
    document.getElementById("overallProgressBar").innerText = `${Math.round(progressPercentage)}%`;

    document.getElementById("progressReport").innerText = 
        completedQuizzes > 0 
            ? `You have completed ${completedQuizzes} out of ${totalQuizzes} quizzes.` 
            : "No quizzes passed yet.";
}

    </script>

<script>
    function searchQuizzes() {
    let input = document.getElementById("quizSearch").value.toLowerCase().trim();
    let quizCards = document.querySelectorAll(".quiz-card");

    quizCards.forEach(card => {
        let title = card.querySelector(".card-title").innerText.toLowerCase();
        let description = card.querySelector(".card-text").innerText.toLowerCase();

        // ‚úÖ Show the quiz card if it matches the search input, otherwise hide it
        if (title.includes(input) || description.includes(input)) {
            card.parentElement.style.display = "block";
        } else {
            card.parentElement.style.display = "none";
        }
    });
}

</script>
</body>
</html>